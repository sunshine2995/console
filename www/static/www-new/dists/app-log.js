webpackJsonp([5],{103:function(module,exports,__webpack_require__){"use strict";function noop(){}function AppLogSocket(option){option=option||{},this.url=option.url,this.instanceId=(option.instanceId||"").substring(0,12),this.serviceId=option.serviceId,this.onOpen=option.onOpen||noop,this.onMessage=option.onMessage||noop,this.onError=option.onError||noop,this.onClose=option.onClose||noop,this.onError=option.onError||noop,this.onSuccess=option.onSuccess||noop,this.onComplete=option.onComplete||noop,this.onFail=option.onFail||noop,this.isAutoConnect=option.isAutoConnect,this.init()}Object.defineProperty(exports,"__esModule",{value:!0});var _timerQueue=__webpack_require__(60),_timerQueue2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(_timerQueue);AppLogSocket.prototype={constructor:AppLogSocket,init:function(){this.webSocket=new WebSocket(this.url),this.webSocket.onopen=this._onOpen.bind(this),this.webSocket.onmessage=this._onMessage.bind(this),this.webSocket.onclose=this._onClose.bind(this),this.webSocket.onerror=this._onError.bind(this),this.timerQueue=new _timerQueue2.default({onExecute:this.onMessage})},getSocket:function(){return this.webSocket},close:function(){this.webSocket.close()},_onOpen:function(evt){this.serviceId&&this.webSocket.send("topic="+this.serviceId),this.onOpen()},_onMessage:function(evt){if(evt.data&&"ok"!==evt.data){var msg=evt.data;msg=this.instanceId?msg.substring(0,12)===this.instanceId?"<p>"+msg.substr(13)+"</p>":"":"<p>"+msg+"</p>",msg&&this.timerQueue.add(msg)}},_onClose:function(evt){this.onClose()},_onError:function(){this.onError()}},exports.default=AppLogSocket},184:function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(exports,"__esModule",{value:!0});var _pageController=__webpack_require__(17),_pageController2=_interopRequireDefault(_pageController),_appApiCenter=__webpack_require__(10),_apiCenter=__webpack_require__(20),_pageAppApiCenter=__webpack_require__(19),_appLogSocket=__webpack_require__(103),_appLogSocket2=_interopRequireDefault(_appLogSocket),_widget=__webpack_require__(4),_widget2=_interopRequireDefault(_widget),template=__webpack_require__(201),Msg=_widget2.default.Message,createReceiveAppTmp=function(apps){for(var longstr="<form>",i=0;i<apps.length;i++)longstr+='<div class="checkbox"><label>',longstr+='<input type="radio" name="app" id="'+apps[i].service_id+'"data-type="'+apps[i].service_type+'"data-alias="'+apps[i].service_alias+'"value="'+apps[i].service_cname+'" />'+apps[i].service_cname,longstr+="</label></div>";return longstr+="</form>"},createAppinstanceTmp=function(dataObj){var msg="<li><a href='javascript:void(0);'  data-key='' class='fn-example'> 全部日志</a></li>",tindex=1;delete dataObj.split;for(var key in dataObj)msg+="<li>",msg+="<a href='javascript:void(0);'  data-key='"+key+"' class='fn-example'> 实例"+tindex+"</a></li>",tindex+=1;return msg},AppLog=(0,_pageController2.default)({template:template,property:{tenantName:"",serviceAlias:"",serviceId:"",socket:null,instanceId:"",status:"start",isAppLogOutput:!1,renderData:{appInfo:{},pageData:{}}},method:{getInitData:function(){var _this=this;(0,_appApiCenter.getAppInfo)(this.tenantName,this.serviceAlias).done(function(appInfo){_this.renderData.appInfo=appInfo,(0,_pageAppApiCenter.getPageLogAppData)(_this.tenantName,_this.serviceAlias).done(function(pageData){_this.renderData.pageData=pageData,_this.render(),setTimeout(function(){_this.initAppIntances(),_this.initLog(),_this.checkAppLogOutput()})})})},checkAppLogOutput:function(){var self=this;(0,_appApiCenter.checkAppLogOutput)(this.tenantName,this.serviceAlias).done(function(){self.setIsApplogOutput(!0)}).fail(function(){self.setIsApplogOutput(!1)})},setIsApplogOutput:function(flag){this.isAppLogOutput=flag,this.isAppLogOutput?$("#logbtn_out").html("取消日志输出").attr("id","logbtn_delete"):$("#logbtn_delete").html("日志输出").attr("id","logbtn_out")},initLog:function(){var self=this;(0,_appApiCenter.getAppLog)(this.tenantName,this.serviceAlias,this.instanceId).done(function(logHtml){$("#docker_log").html(logHtml||""),self.initSocket()})},initSocket:function(){var self=this;if(this.socket)try{this.socket.close(),this.socket=null}catch(e){}(0,_appApiCenter.getAppLogSocketUrl)(this.tenantName,this.serviceAlias).done(function(url){self.socket=new _appLogSocket2.default({url:url,instanceId:self.instanceId,serviceId:self.serviceId,onMessage:function(msg){"start"==self.status&&$(msg).prependTo($("#docker_log"))}})})},initAppIntances:function(){(0,_appApiCenter.getAppContainer)(this.tenantName,this.serviceAlias).done(function(dataObj){$("#cur_container_content").html(createAppinstanceTmp(dataObj))})},showLogOutputDialog:function(){var self=this;(0,_apiCenter.getCanReceiveLogApp)(this.tenantName).done(function(apps){var dialog=_widget2.default.create("dialog",{title:"指定日志应用",id:"logOutput",width:"500px",height:"300px",domEvents:{".btn-success click":function(){var serviceId=dialog.getElement().find("input[type='radio']:checked").attr("id"),serviceType=dialog.getElement().find("input[type='radio']:checked").attr("data-type");self.handleSetAppLogOutput(serviceId,serviceType).done(function(){self.setIsApplogOutput(!0),Msg.success("操作成功"),dialog.destroy(),dialog=null})}}});dialog.appendContent($("#setAppOutputDialogTmp").html()),dialog.appendContent(createReceiveAppTmp(apps)),dialog.getElement().find("input").eq(0).attr("checked","true")})},handleSetAppLogOutput:function(serviceId,serviceType){return(0,_appApiCenter.setAppLogOutput)(this.tenantName,this.serviceAlias,serviceId,serviceType)},handleCancelAppLogOutput:function(){var self=this;(0,_appApiCenter.cancelAppLogOutput)(this.tenantName,this.serviceAlias).done(function(data){self.setIsApplogOutput(!1)})},openStatus:function(initSocket){this.status="start",$(".js-status-control").html("暂停"),initSocket&&this.initSocket()},closeStatus:function(){this.status="stop",$(".js-status-control").html("开始"),this.socket.close()}},domEvents:{".fn-example click":function(e){var $target=$(e.currentTarget);this.instanceId=$target.attr("data-key"),$(".log-type-text").html($target.html()),this.openStatus(),this.initLog()},".js-status-control click":function(){"stop"==this.status?this.openStatus(!0):"start"==this.status&&this.closeStatus()},"#logbtn_out click":function(){this.showLogOutputDialog()},"#logbtn_delete click":function(){this.handleCancelAppLogOutput()}},onReady:function(){this.renderData.tenantName=this.tenantName,this.renderData.serviceAlias=this.serviceAlias,this.getInitData()}});window.AppLogController=AppLog,exports.default=AppLog},201:function(module,exports){module.exports='    <section class="clearfix">\n        <button type="button" class="btn btn-success js-status-control" id="logbtn">暂停</button>\n        {{if !pageData.is_private}}\n        <button  type="button" class="btn btn-success" id="logbtn_out" style="display: none;">日志输出</button>\n        {{/if}}\n        <div class="btn-group" style="display: none;">\n            <button type="button" name="join_container" class="dropdown-toggle btn-success btn" aria-haspopup="true" aria-expanded="false" data-toggle="dropdown"  id="join_container">\n                <span class="log-type-text">全部日志</span> <span class="caret"></span>\n            </button>\n            <ul class="dropdown-menu" role="menu" id="cur_container_content">\n                                           \n            </ul>\n        </div>\n        <p class="pull-right">\n            <a href="/apps/{{tenantName}}/{{serviceAlias}}/history-log/" target="_blank">历史日志下载</a>\n            <a href="/apps/{{tenantName}}/{{serviceAlias}}/latest-log/" target="_blank">最新1000条日志</a>\n        </p>\n    </section>\n    <div class="main_log" id="onofflogajax">\n        <div id="docker_log" role="tabpanel" class="inside_log">\n        </div>\n    </div>\n<script type="text/template" id="setAppOutputDialogTmp">\n    <p class="tipstextlog">下方为当前团队已经安装的日志应用列表，可以为当前应用指定一个应用来接受日志数据的输入。目前支持日志的应用类型有：<a href="http://app.goodrain.com/detail/31/">elasticsearch</a>、<a href="http://app.goodrain.com/detail/3/">mongodb</a>、influxdb等，如需安装可直接点击文字去部署。</p>\n<\/script>'},529:function(module,exports,__webpack_require__){module.exports=__webpack_require__(184)},59:function(module,exports,__webpack_require__){"use strict";function Queue(){this.datas=[]}Object.defineProperty(exports,"__esModule",{value:!0}),Queue.prototype={constructor:Queue,push:function(data){void 0!==data&&this.datas.push(data)},shift:function(){return this.datas.shift()},getCount:function(){return this.datas.length},empty:function(){return 0===this.datas.length}},exports.default=Queue},60:function(module,exports,__webpack_require__){"use strict";function TimerQueue(option){option=option||{},this.queue=new _queue2.default,this.timer=null,this.isStarted=!1,this.interval=option.interval||300,this.onExecute=option.onExecute||util.noop}Object.defineProperty(exports,"__esModule",{value:!0});var _queue=__webpack_require__(59),_queue2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(_queue);TimerQueue.prototype={add:function(data){this.queue.push(data),this.isStarted||this.start()},start:function(){var self=this;this.timer=setInterval(function(){self.queue.empty()?self.stop():self.execute()},this.interval)},stop:function(){this.isStarted=!1,clearInterval(this.timer)},execute:function(){this.onExecute(this.queue.shift())}},exports.default=TimerQueue}},[529]);